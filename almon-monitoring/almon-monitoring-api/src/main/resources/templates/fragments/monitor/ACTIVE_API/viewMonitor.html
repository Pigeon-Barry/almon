<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" lang="en"
>

<div class="container-fluid" th:fragment="view">
    <!--/*@thymesVar id="monitor" type="com.capgemini.bedwards.almon.almondatastore.models.monitor.Monitor"*/-->
    <!--/*@thymesVar id="service" type="com.capgemini.bedwards.almon.almondatastore.models.service.Service"*/-->
    <!--/*@thymesVar id="listAlerts" type="java.util.List"*/-->
    <!--/*@thymesVar id="alert" type="com.capgemini.bedwards.almon.almondatastore.models.alert.Alert"*/-->
    <!--/*@thymesVar id="alertFilterOptions" type="com.capgemini.bedwards.almon.almondatastore.models.alert.AlertFilterOptions"*/-->
    <!--/*@thymesVar id="notifications" type="com.capgemini.bedwards.almon.notificationcore.Notifications"*/-->
    <div class="overlay" id="runningOverlay">
        <div class="spinner"></div>
        <br/>
        Running ...
    </div>


    <section style="background-color: #eee;">
        <div class="container py-5">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-body text-center">
                            <h4>Monitor</h4>
                            <h5 class="my-3" th:text="${monitor.getId()}"></h5>
                            <!--                        <p class="text-muted mb-1">Placeholder</p>-->
                            <!--                        <p class="text-muted mb-4">Placeholder</p>-->
                            <div class="d-flex justify-content-center mb-2"
                                 th:if="${#authorization.expression('hasAuthority(''RUN_MONITORS'') || hasAuthority(''SERVICE_' + service.getId() + '_MONITOR_' + monitor.getId() +'_CAN_RUN'')')}"
                            >
                                <button type="button" class="btn btn-primary"
                                        th:data-monitorId="${monitor.getId()}"
                                        th:data-serviceId="${service.getId()}"
                                        onclick="runMonitor(this.getAttribute('data-serviceId'),this.getAttribute('data-monitorId'),'runningOverlay')"
                                >Run Now
                                </button>
                            </div>
                            <div>
                                <div class="d-flex justify-content-center mb-2">
                                    <th:block
                                            th:if="${#authorization.expression('hasAuthority(''ENABLE_DISABLE_MONITORS'') || hasAuthority(''SERVICE_' + monitor.getId() + '_MONITOR_' + monitor.getId() +'_CAN_ENABLE_DISABLE'')')}">
                                        <button th:if="${monitor.isEnabled()}" href="#" class="btn btn-danger mx-2"
                                                th:data-monitorId="${monitor.getId()}"
                                                th:data-serviceId="${service.getId()}"
                                                onclick="disableMonitor(this.getAttribute('data-serviceId'),this.getAttribute('data-monitorId'),this)"
                                        >Disable Monitor
                                        </button>
                                        <button th:if="${!monitor.isEnabled()}" href="#" class="btn btn-success mx-2"
                                                th:data-monitorId="${monitor.getId()}"
                                                th:data-serviceId="${service.getId()}"
                                                onclick="enableMonitor(this.getAttribute('data-serviceId'),this.getAttribute('data-monitorId'),this)"
                                        >Enable Monitor
                                        </button>
                                    </th:block>
                                    <th:block
                                            th:if="${#authorization.expression('hasAuthority(''DELETE_MONITORS'') || hasAuthority(''SERVICE_' + monitor.getId() + '_MONITOR_' + monitor.getId() +'_CAN_DELETE'')')}">
                                        <button href="#" class="btn btn-danger mx-2"
                                                th:data-monitorId="${monitor.getId()}"
                                                th:data-serviceId="${service.getId()}"
                                                onclick="deleteMonitor(this.getAttribute('data-serviceId'),this.getAttribute('data-monitorId'),this)"
                                        >Delete Monitor
                                        </button>
                                    </th:block>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-4 mb-lg-0">
                        <div class="card-body p-0">
                            <form th:object="${alertFilterOptions}" method="get" id="alertFilterForm">
                                <input class="form-control" type="hidden" name="alertPageNumber"
                                       th:value="${currentPage}"/>
                                <input class="form-control" type="hidden" name="alertPageSize" th:value="${pageSize}"/>
                                <ul class="list-group list-group-flush rounded-3">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <p class="mb-0"><strong>Filter</strong></p>
                                    </li>
                                    <li class="list-group-item">
                                        <label>Date Range:</label><br>
                                        <textarea class="form-control" id="alertRangePicker" type="text"
                                                  placeholder="DD/MM/YYYY hh:mm:ss AM - DD/MM/YYYY hh:mm:ss PM"
                                                  style="resize: none;"
                                                  readonly="readonly"></textarea>
                                        <input class="form-control" id="alertRangeTo" name="to" type="hidden"/>
                                        <input class="form-control" id="alertRangeFrom" name="from" type="hidden"/>
                                    </li>
                                    <li class="list-group-item">
                                        <label>Status</label>
                                        <ul th:each="statusEnum : ${T(com.capgemini.bedwards.almon.almondatastore.models.alert.Status).values()}">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="status"
                                                       th:value="${statusEnum}"
                                                       th:field="*{status}"
                                                       th:id="'filter' + ${statusEnum}">
                                                <label class="form-check-label" th:for="'filter' + ${statusEnum}"
                                                       th:text="${statusEnum}"></label>
                                            </div>
                                        </ul>
                                    </li>

                                    <li class="list-group-item  d-flex justify-content-between">
                                        <button onclick="resetAlertFilter()" type="button" class="btn btn-danger">
                                            Reset Filter
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            Apply Filter
                                        </button>
                                    </li>
                                </ul>
                            </form>
                        </div>
                    </div>
                    <br>
                    <div class="card mb-4 mb-lg-0">
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush rounded-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <p class="mb-0"><strong>Notification Subscriptions</strong></p>
                                </li>
                                <li class="list-group-item d-flex justify-content-between"
                                    th:each="notification : ${notifications.getNotifications()}">

                                    <p data-bs-toggle="tooltip" data-bs-placement="top"
                                       th:data-bs-title="${notification.getHelpText()}"
                                       data-bs-custom-class="primary-tooltip"
                                       class="mb-0" th:text="${notification.getDisplayName()}"></p>
                                    <div class="justify-content-end">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                   th:data-notificationId="${notification.getId()}"
                                                   th:data-serviceId="${service.getId()}"
                                                   th:checked="${notifications.isUserSubscribedToNotification(user,notification,service)}"
                                                   onclick="updateNotificationStatus(this.getAttribute('data-notificationId'),this.getAttribute('data-serviceId'),this.is(':checked'))"
                                            >
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>


                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-3">
                                    <p class="mb-0">Service Name</p>
                                </div>
                                <div class="col-sm-9">
                                    <a th:href="'/web/service/' + ${service.id}"><p class="text-muted mb-0"
                                                                                    th:text="${service.getName()}"></p>
                                    </a>
                                </div>
                            </div>
                            <hr>

                            <div class="row">
                                <div class="col-sm-3">
                                    <p class="mb-0">Monitor Name</p>
                                </div>
                                <div class="col-sm-9">
                                    <p class="text-muted mb-0" th:text="${monitor.getName()}"></p>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3">
                                    <p class="mb-0">Monitor Description</p>
                                </div>
                                <div class="col-sm-9">
                                    <p class="text-muted mb-0" th:text="${monitor.getDescription()}"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4 mb-md-0">
                                <div class="card-title">
                                    <ul class="list-group list-group-flush rounded-3">
                                        <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                                            <p class="mb-0"><strong>Alerts</strong></p>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body row col-12">
                                    <table class="table table-striped table-responsive-md">
                                        <thead>
                                        <tr>
                                            <th>Created At</th>
                                            <th>Status</th>
                                            <th class="d-flex justify-content-end">Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="alert : ${listAlerts}">
                                            <td th:text="${alert.getCreatedAt()}"></td>
                                            <td th:text="${alert.getStatus()}"></td>
                                            <td class="d-flex justify-content-end">
                                                <a href="#" class="btn btn-primary mx-2">View Details</a>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>

                                    <th:block th:insert="fragments/util/pagintation :: standard('Alerts','alert')"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script type="text/javascript">

        function resetAlertFilter() {
            if (!confirmationPrompt("Reset Filter", "Are you sure you want to reset this filter?"))
                return;
            deleteQueryParam(['status','from','to']);
        }

        const PICKER_DATE_FORMAT = 'DD/MM/YYYY h:mm:ss A';
        const SUBMIT_DATE_FORMAT = 'YYYY-MM-DD HH:mm:ss';

        function updateDateRange(startDate, endDate) {
            if (startDate.isValid())
                $('#alertRangeFrom').val(startDate.format(SUBMIT_DATE_FORMAT));
            if (endDate.isValid())
                $('#alertRangeTo').val(endDate.format(SUBMIT_DATE_FORMAT));

            if (!startDate.isValid() || !endDate.isValid())
                return;
            $('#alertRangePicker').val(startDate.format(PICKER_DATE_FORMAT) + ' - ' + endDate.format(PICKER_DATE_FORMAT));
        }

        $(function () {
            const picker = $('#alertRangePicker').daterangepicker({
                timePicker: true,
                autoUpdateInput: false,
                alwaysShowCalendars: true,
                timePickerSeconds: true,
                locale: {
                    format: PICKER_DATE_FORMAT
                },
                ranges: {
                    'Today': [moment().startOf('day'), moment().endOf('day')],
                    'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
                    'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment().endOf('day')],
                    'Last 30 Days': [moment().subtract(29, 'days').startOf('day'), moment().endOf('day')],
                    'This Month': [moment().startOf('month').startOf('day'), moment().endOf('month').endOf('day')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month').endOf('day')]
                },
                maxDate: moment().endOf('day')
            });

            const from = '[[${param.from}]]';
            const to = '[[${param.to}]]';
            const fromDate = moment(from, SUBMIT_DATE_FORMAT);
            const toDate = moment(to, SUBMIT_DATE_FORMAT);


            if (fromDate.isValid()) {
                $('#alertRangePicker').data('daterangepicker').setStartDate(fromDate.format(PICKER_DATE_FORMAT));
            }
            if (toDate.isValid()) {
                $('#alertRangePicker').data('daterangepicker').setEndDate(toDate.format(PICKER_DATE_FORMAT));
            }
            updateDateRange(fromDate, toDate);
        });
        $('#alertRangePicker').on('apply.daterangepicker', function (ev, picker) {
            updateDateRange(picker.startDate, picker.endDate);
        });

        $('#alertRangePicker').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
            $('#alertRangeTo').val('');
            $('#alertRangeFrom').val('');
        });


    </script>
    <script
            th:if="${#authorization.expression('hasAuthority(''ENABLE_DISABLE_MONITORS'') || hasAuthority(''SERVICE_' + service.getId() + '_MONITOR_' + monitor.getId() +'_CAN_ENABLE_DISABLE'')')}"
            th:src="@{/web/js/monitor/enableDisableMonitor.js}">
    </script>
    <script
            th:if="${#authorization.expression('hasAuthority(''RUN_MONITORS'') || hasAuthority(''SERVICE_' + service.getId() + '_MONITOR_' + monitor.getId() +'_CAN_RUN'')')}"
            th:src="@{/web/js/monitor/runMonitor.js}">
    </script>
    <script
            th:if="${#authorization.expression('hasAuthority(''DELETE_MONITORS'') || hasAuthority(''SERVICE_' + service.getId() + '_MONITOR_' + monitor.getId() +'_CAN_DELETE'')')}"
            th:src="@{/web/js/monitor/deleteMonitor.js}">
    </script>
</div>
